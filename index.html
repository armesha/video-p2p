<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>P2P Video Call</title>
</head>
<body>
  <h1>P2P Video Call (WebRTC via Simple-Peer & Firebase)</h1>

  <div>
    <label><input type="radio" name="role" value="caller" checked> Caller</label>
    <label style="margin-left:1rem;"><input type="radio" name="role" value="receiver"> Receiver</label>
    <button id="callBtn">Call</button>
  </div>

  <div style="margin-top:1rem; display:flex; gap:2rem; flex-wrap:wrap;">
    <div>
      <h3>Your Video</h3>
      <video id="localVideo" width="320" height="240" playsinline autoplay muted></video>
    </div>
    <div>
      <h3>Remote Video</h3>
      <video id="remoteVideo" width="320" height="240" playsinline autoplay></video>
    </div>
  </div>

  <script src="libs/firebase-app-compat.js"></script>
  <script src="libs/firebase-database-compat.js"></script>
  <script src="libs/simplepeer.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA5EenGyTOzqgK8uUpAzWS39w0RhrdBNvE",
      authDomain: "fir-first-8e963.firebaseapp.com",
      databaseURL: "https://fir-first-8e963-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "fir-first-8e963",
      storageBucket: "fir-first-8e963.firebasestorage.app",
      messagingSenderId: "1062635456612",
      appId: "1:1062635456612:web:92bd6827e19fa6190a3771"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const callBtn    = document.getElementById("callBtn");
    const localVideo = document.getElementById("localVideo");
    const remoteVideo= document.getElementById("remoteVideo");
    const roleInputs = Array.from(document.querySelectorAll('input[name="role"]'));

    const ROOM_ID = "test-room";
    let peer          = null;
    let localStream   = null;
    let roomRef       = null;
    let isInitiator   = false;
    const firebaseListeners = [];

    function setStatus(text) {
      console.log("[STATUS]", text);
    }

    async function getLocalStream(withAudio = false) {
      if (localStream) return localStream;
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: withAudio });
        localVideo.srcObject = stream;
        localStream = stream;
        setStatus("Media ready");
        return stream;
      } catch (err) {
        console.error("getUserMedia error:", err);
        setStatus("Media access denied");
        throw err;
      }
    }

    function addFirebaseListener(ref, event, cb) {
      ref.on(event, cb);
      firebaseListeners.push({ ref, event, cb });
    }

    function detachAllFirebaseListeners() {
      firebaseListeners.forEach(({ ref, event, cb }) => ref.off(event, cb));
      firebaseListeners.length = 0;
    }

    function createPeer(initiator) {
      isInitiator = initiator;
      peer = new SimplePeer({
        initiator,
        trickle: false, 
        stream: localStream,
        config: {
          // stun je pro zjištění IP adresy. Počitač se ptá na server, který mu řekne, jakou má IP adresu.
          iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "stun:stun1.l.google.com:19302" },
            { urls: "stun:stun2.l.google.com:19302" },
          ],
        },
      });

      peer.on("signal", data => {
        const path = initiator ? "initiator" : "answer";
        console.log("Sending signal", data);
        roomRef.child(path).push(JSON.stringify(data));
      });

      peer.on("connect", () => {
        setStatus("P2P connected");
        console.log("Peer connected");
      });

      peer.on("stream", stream => {
        remoteVideo.srcObject = stream;
        setStatus("Remote stream received");
      });

      peer.on("error", err => {
        console.error("Peer error:", err);
        setStatus("Peer error - see console");
      });
    }

    function listenForRemoteSignals() {
      const remotePath = isInitiator ? "answer" : "initiator";
      const remoteRef = roomRef.child(remotePath);

      addFirebaseListener(remoteRef, "child_added", snap => {
        const data = JSON.parse(snap.val());
        console.log("Received remote signal", data);
        if (peer) peer.signal(data);
      });
    }

    async function startCall() {
      setStatus("Starting call (initiator)…");
      roomRef = database.ref(ROOM_ID);
      await roomRef.remove();

      await getLocalStream(true);
      createPeer(true);
      listenForRemoteSignals();
    }

    // Receiver auto-answer support
    let receiverInitiatorRef = null;
    let receiverInitiatorListener = null;

    function setupReceiverAutoAnswer() {
      const selected = roleInputs.find(r => r.checked)?.value || "caller";
      if (selected !== "receiver") return;

      roomRef = database.ref(ROOM_ID);
      if (!receiverInitiatorRef) {
        receiverInitiatorRef = roomRef.child("initiator");
      }

      // Ensure media is ready so we can attach stream immediately when creating peer
      getLocalStream(true).catch(() => {});

      // Detach previous listener if any
      if (receiverInitiatorListener) {
        receiverInitiatorRef.off("child_added", receiverInitiatorListener);
        receiverInitiatorListener = null;
      }

      receiverInitiatorListener = (snap) => {
        const data = JSON.parse(snap.val());
        console.log("Auto-answer: received initiator signal", data);
        // Create answerer peer lazily on first initiator signal if not created
        if (!peer) {
          createPeer(false);
          listenForRemoteSignals();
        }
        if (peer) {
          try {
            peer.signal(data);
          } catch (e) {
            console.error("Error signaling peer with initiator offer:", e);
          }
        }
      };

      addFirebaseListener(receiverInitiatorRef, "child_added", receiverInitiatorListener);
      setStatus("Receiver is waiting and will auto-answer incoming call…");
    }

    function teardownReceiverAutoAnswer() {
      if (receiverInitiatorRef && receiverInitiatorListener) {
        receiverInitiatorRef.off("child_added", receiverInitiatorListener);
        receiverInitiatorListener = null;
      }
    }

    function hangUp() {
      setStatus("Hanging up…");

      teardownReceiverAutoAnswer();

      if (peer) {
        peer.destroy();
        peer = null;
      }

      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
        localVideo.srcObject = null;
      }

      remoteVideo.srcObject = null;
      detachAllFirebaseListeners();

      if (roomRef && isInitiator) roomRef.remove();

      setStatus("Idle");
    }

    function updateCallButtonVisibility() {
      const selected = roleInputs.find(r => r.checked)?.value || "caller";
      callBtn.style.display = selected === "caller" ? "inline-block" : "none";
      if (selected === "receiver") {
        setupReceiverAutoAnswer();
      } else {
        teardownReceiverAutoAnswer();
      }
    }
    roleInputs.forEach(r => r.addEventListener("change", updateCallButtonVisibility));
    updateCallButtonVisibility();
    // If default role is receiver, ensure auto-answer is primed
    if ((roleInputs.find(r => r.checked)?.value || "caller") === "receiver") {
      setupReceiverAutoAnswer();
    }

    callBtn.addEventListener("click", async () => {
      const selected = roleInputs.find(r => r.checked)?.value || "caller";
      if (selected === "caller") {
        await startCall();
      }
    });
    window.addEventListener("beforeunload", hangUp);
  </script>
</body>
</html>