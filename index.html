<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>P2P Video Call</title>
</head>
<body>
  <h1>P2P Video Call (WebRTC via Simple-Peer & Firebase)</h1>

  <div>
    <button id="startBtn">Start Call</button>
    <button id="joinBtn">Join Call</button>
    <button id="hangupBtn" disabled>Hang Up</button>
    <span id="status">Idle</span>
  </div>

  <div style="margin-top:1rem; display:flex; gap:2rem; flex-wrap:wrap;">
    <div>
      <h3>Your Video</h3>
      <video id="localVideo" width="320" height="240" playsinline autoplay muted></video>
    </div>
    <div>
      <h3>Remote Video</h3>
      <video id="remoteVideo" width="320" height="240" playsinline autoplay></video>
    </div>
  </div>

  <script src="libs/firebase-app-compact.js"></script>
  <script src="libs/firebase-database-compact.js"></script>
  <script src="libs/simplepeer.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA5EenGyTOzqgK8uUpAzWS39w0RhrdBNvE",
      authDomain: "fir-first-8e963.firebaseapp.com",
      databaseURL: "https://fir-first-8e963-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "fir-first-8e963",
      storageBucket: "fir-first-8e963.firebasestorage.app",
      messagingSenderId: "1062635456612",
      appId: "1:1062635456612:web:92bd6827e19fa6190a3771"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const startBtn   = document.getElementById("startBtn");
    const joinBtn    = document.getElementById("joinBtn");
    const hangupBtn  = document.getElementById("hangupBtn");
    const statusEl   = document.getElementById("status");
    const localVideo = document.getElementById("localVideo");
    const remoteVideo= document.getElementById("remoteVideo");

    const ROOM_ID = "test-room";
    let peer          = null;
    let localStream   = null;
    let roomRef       = null;
    let isInitiator   = false;
    const firebaseListeners = [];

    function setStatus(text) {
      statusEl.textContent = text;
      console.log("[STATUS]", text);
    }

    async function getLocalStream() {
      if (localStream) return localStream;
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        localVideo.srcObject = stream;
        localStream = stream;
        setStatus("Camera ready");
        return stream;
      } catch (err) {
        console.error("getUserMedia error:", err);
        setStatus("Camera access denied");
        throw err;
      }
    }

    function addFirebaseListener(ref, event, cb) {
      ref.on(event, cb);
      firebaseListeners.push({ ref, event, cb });
    }

    function detachAllFirebaseListeners() {
      firebaseListeners.forEach(({ ref, event, cb }) => ref.off(event, cb));
      firebaseListeners.length = 0;
    }

    function createPeer(initiator) {
      isInitiator = initiator;
      peer = new SimplePeer({
        initiator,
        trickle: false, // send SDP only after ICE gathering completes for reliability across NATs
        stream: localStream,
        config: {
          iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "stun:stun1.l.google.com:19302" },
            { urls: "stun:stun2.l.google.com:19302" },
          ],
        },
      });

      peer.on("signal", data => {
        const path = initiator ? "initiator" : "answer";
        console.log("Sending signal", data);
        roomRef.child(path).push(JSON.stringify(data));
      });

      peer.on("connect", () => {
        setStatus("P2P connected");
        hangupBtn.disabled = false;
        console.log("Peer connected");
      });

      peer.on("stream", stream => {
        remoteVideo.srcObject = stream;
        setStatus("Remote stream received");
      });

      peer.on("error", err => {
        console.error("Peer error:", err);
        setStatus("Peer error - see console");
      });
    }

    function listenForRemoteSignals() {
      const remotePath = isInitiator ? "answer" : "initiator";
      const remoteRef = roomRef.child(remotePath);

      addFirebaseListener(remoteRef, "child_added", snap => {
        const data = JSON.parse(snap.val());
        console.log("Received remote signal", data);
        if (peer) peer.signal(data);
      });
    }

    async function startCall() {
      setStatus("Starting call (initiator)…");
      roomRef = database.ref(ROOM_ID);
      await roomRef.remove();

      await getLocalStream();
      createPeer(true);
      listenForRemoteSignals();
    }

    async function joinCall() {
      setStatus("Joining call (answerer)…");
      roomRef = database.ref(ROOM_ID);

      await getLocalStream();
      createPeer(false);
      listenForRemoteSignals();
    }

    function hangUp() {
      setStatus("Hanging up…");
      hangupBtn.disabled = true;

      if (peer) {
        peer.destroy();
        peer = null;
      }

      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
        localVideo.srcObject = null;
      }

      remoteVideo.srcObject = null;
      detachAllFirebaseListeners();

      if (roomRef && isInitiator) roomRef.remove();

      setStatus("Idle");
    }

    startBtn.addEventListener("click", startCall);
    joinBtn.addEventListener("click", joinCall);
    hangupBtn.addEventListener("click", hangUp);
    window.addEventListener("beforeunload", hangUp);
  </script>
</body>
</html>