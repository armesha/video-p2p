<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>P2P Video Call</title>
</head>

<body>
  <h1>P2P Video Call (WebRTC via Simple-Peer & Manual Signaling)</h1>

  <div>
    <button id="startBtn">Start Call</button>
    <button id="joinBtn">Join Call</button>
  </div>

  <div id="signal-ui" style="margin-top:1rem; display:grid; gap:0.75rem; max-width:800px;">
    <div>
      <label><strong>Local Description (copy manually):</strong></label>
      <textarea id="localDesc" rows="8" style="width:100%;"></textarea>
    </div>
    <div>
      <label><strong>Remote Description (paste manually):</strong></label>
      <textarea id="remoteDesc" rows="8" style="width:100%;"></textarea>
    </div>
  </div>

  <div style="margin-top:1rem; display:flex; gap:2rem; flex-wrap:wrap;">
    <div>
      <h3>Your Video</h3>
      <video id="localVideo" width="320" height="240" playsinline autoplay muted></video>
    </div>
    <div>
      <h3>Remote Video</h3>
      <video id="remoteVideo" width="320" height="240" playsinline autoplay></video>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>
  <script>
    const startBtn = document.getElementById("startBtn");
    const joinBtn = document.getElementById("joinBtn");
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");

    let peer = null;
    let localStream = null;
    let isInitiator = false;

    async function getLocalStream() {
      if (localStream) return localStream;
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      localVideo.srcObject = stream;
      localStream = stream;
      return stream;
    }

    function createPeer(initiator) {
      isInitiator = initiator;
      peer = new SimplePeer({
        initiator,
        trickle: false,
        stream: localStream,
        config: {
          iceServers: [
            { urls: "stun:stun1.l.google.com:19302" },
          ],
        },
      });

      peer.on("signal", data => {
        const sdpBlob = JSON.stringify(data, null, 2);
        const localDesc = document.getElementById("localDesc");
        localDesc.value = sdpBlob;
      });

      peer.on("connect", () => {
        console.log("Peer connected");
      });

      peer.on("stream", stream => {
        remoteVideo.srcObject = stream;
      });

      peer.on("error", err => {
        console.error("Peer error:", err);
      });
    }

    function listenForRemoteSignals() {
      const remoteDesc = document.getElementById("remoteDesc");
      function tryApply() {
        if (!peer) return;
        const text = remoteDesc.value.trim();
        if (!text) return;
        try {
          const data = JSON.parse(text);
          peer.signal(data);
          remoteDesc.removeEventListener("input", tryApply);
        } catch (e) {
          return;
        }
      }
      remoteDesc.addEventListener("input", tryApply);
    }

    async function startCall() {
      await getLocalStream();
      createPeer(true);
      listenForRemoteSignals();
    }

    async function joinCall() {
      await getLocalStream();
      createPeer(false);
      listenForRemoteSignals();
    }

    startBtn.addEventListener("click", startCall);
    joinBtn.addEventListener("click", joinCall);
  </script>
</body>

</html>