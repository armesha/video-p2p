<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>P2P Video Call</title>
</head>
<body>
  <h1>P2P Video Call (PeerJS only)</h1>

  <div>
    <button id="startBtn">Start Call</button>
    <button id="joinBtn">Join Call</button>
    <button id="hangupBtn" disabled>Hang Up</button>
    <span id="status">Idle</span>
  </div>

  <div style="margin-top:1rem; display:flex; gap:2rem; flex-wrap:wrap;">
    <div>
      <h3>Your Video</h3>
      <video id="localVideo" width="320" height="240" playsinline autoplay muted></video>
    </div>
    <div>
      <h3>Remote Video</h3>
      <video id="remoteVideo" width="320" height="240" playsinline autoplay></video>
    </div>
  </div>

  <script src="libs/peerjs.js"></script>

  <script>
    const startBtn   = document.getElementById("startBtn");
    const joinBtn    = document.getElementById("joinBtn");
    const hangupBtn  = document.getElementById("hangupBtn");
    const statusEl   = document.getElementById("status");
    const localVideo = document.getElementById("localVideo");
    const remoteVideo= document.getElementById("remoteVideo");

    let localStream = null;
    let peer = null;
    let mediaConn = null;

    function setStatus(text) {
      statusEl.textContent = text;
      console.log("[STATUS]", text);
    }

    async function getLocalStream() {
      if (localStream) return localStream;
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        localVideo.srcObject = stream;
        localStream = stream;
        setStatus("Camera ready");
        return stream;
      } catch (err) {
        console.error("getUserMedia error:", err);
        setStatus("Camera access denied");
        throw err;
      }
    }

    function ensurePeer() {
      if (peer && !peer.destroyed) return peer;
      const id = location.hash.replace("#","") || "test";
      peer = new window.peerjs.Peer(id, {
        host: location.hostname,
        port: location.port ? parseInt(location.port, 10) : (location.protocol === "https:" ? 443 : 80),
        path: "/",
        secure: location.protocol === "https:",
        config: {
          iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "stun:stun1.l.google.com:19302" },
            { urls: "stun:stun2.l.google.com:19302" }
          ],
          sdpSemantics: "unified-plan"
        }
      });

      let reopened = false;
      peer.on("open", pid => {
        setStatus("Peer ready: " + pid);
        if (reopened) peer.reconnect();
      });

      peer.on("disconnected", () => {
        setStatus("Peer disconnected");
        if (!peer.destroyed) {
          reopened = true;
          peer.reconnect();
        }
      });

      peer.on("close", () => {
        setStatus("Peer closed");
      });

      peer.on("error", () => {
        setStatus("Peer error");
      });

      peer.on("call", call => {
        mediaConn = call;
        mediaConn.on("stream", stream => {
          remoteVideo.srcObject = stream;
          setStatus("Remote stream received");
        });
        mediaConn.on("close", () => {
          setStatus("Call closed");
          hangupBtn.disabled = true;
        });
      });

      return peer;
    }

    async function startCall() {
      setStatus("Starting call (initiator)…");
      await getLocalStream();
      const p = ensurePeer();

      const waitOpen = new Promise(res => {
        if (p.open) return res();
        p.once("open", () => res());
      });
      await waitOpen;

      const targetId = "test-peer";
      mediaConn = p.call(targetId, localStream);
      if (!mediaConn) {
        setStatus("Failed to start call");
        return;
      }

      mediaConn.on("stream", stream => {
        remoteVideo.srcObject = stream;
        setStatus("Remote stream received");
      });

      mediaConn.on("close", () => {
        setStatus("Call closed");
        hangupBtn.disabled = true;
      });

      mediaConn.on("error", () => {
        setStatus("Media connection error");
      });

      hangupBtn.disabled = false;
      setStatus("Calling…");
    }

    async function joinCall() {
      setStatus("Joining call (answerer)…");
      await getLocalStream();
      const p = ensurePeer();

      const waitOpen = new Promise(res => {
        if (p.open) return res();
        p.once("open", () => res());
      });
      await waitOpen;

      setStatus("Waiting for incoming call…");

      p.off && p.off("call");
      p.on("call", call => {
        mediaConn = call;
        call.answer(localStream);
        call.on("stream", stream => {
          remoteVideo.srcObject = stream;
          setStatus("Remote stream received");
        });
        call.on("close", () => {
          setStatus("Call closed");
          hangupBtn.disabled = true;
        });
        call.on("error", () => {
          setStatus("Media connection error");
        });
        hangupBtn.disabled = false;
        setStatus("P2P connected");
      });
    }

    function hangUp() {
      setStatus("Hanging up…");
      hangupBtn.disabled = true;

      if (mediaConn) {
        try { mediaConn.close(); } catch (_) {}
        mediaConn = null;
      }

      if (peer) {
        try { peer.disconnect(); } catch (_) {}
        try { peer.destroy(); } catch (_) {}
        peer = null;
      }

      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
        localVideo.srcObject = null;
      }

      remoteVideo.srcObject = null;
      setStatus("Idle");
    }

    startBtn.addEventListener("click", startCall);
    joinBtn.addEventListener("click", joinCall);
    hangupBtn.addEventListener("click", hangUp);
    window.addEventListener("beforeunload", hangUp);
  </script>
</body>
</html>